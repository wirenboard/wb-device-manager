## Check-list работоспособности сервиса wb-device-manager

### Общие требования
* пакет собирается на Jenkins; unit-тесты **запускаются** и отрабатывают корректно
* systemd-сервис wb-device-manager запущен после установки пакета; запущен после перезагрузки WB
* journalctl -u wb-device-manager -f не выдаёт debug-сообщения
* systemd-сервис wb-device-manager не пытается перезапускаться при отсутствии соединения с mosquitto
* при остановке mosquitto, сервис wb-device-manager остаётся running; перезапуск сервиса приводит к failed
* корректный exit-code (остановить systemd-сервис; запускать утилиту вручную):
    * 2 - на запуск с недопустимыми ключами
* при запуске вручную, нормально останавливается по Ctrl+C; без зависаний и ругательств
* на пропажу связи с mosquitto - ругается ворнингами
* после пропажи и последующего восстановления соединения с mosquitto - работает **без необходимости перезапуска**

### Интерфейс rpc наружу
* rpc-запрос к wb-device-manager с неправильными параметрами возвращает ошибку (32700)
* быстрый повторный rpc-запрос на начало сканирования (`wb-device-manager/bus-scan/Start/client_id`) с неизменными параметрами возвращает ошибку (33100)
* запрос на остановку сканирования (если оно не выполняется) (`wb-device-manager/bus-scan/Stop/client_id`) возвращает ошибку (33100)
* при запуске сервис отдаёт наружу свои rpc-ручки (посмотреть в ``/rpc/v1/wb-device-manager/#``)
* при запуске сервис шлёт в топик состояния state с пустым списком устройств
* при остановке - сервис чистит топики
    * #### сканирование портов (*/bus-scan/Start):
        * сразу возвращает ответ (и запускает сканирование устройств под капотом)
        * пока идёт сканирование - возвращает ошибку 33100 на повторные вызовы
        * первая публикация state после начала сканирования возвращает изначальное состояние (нет устройств с предыдущего сканирования)
        * в процессе сканирования - публикует json всего состояния в /wb-device-manager/state (на каждую комбинацию serial-настроек)
        * не блокирует другие rpc-вызовы к wb-device-manager
        * остановив wb-mqtt-serial перед сканированием, получаем ошибку "com.wb.device_manager.rpc_call_timeout_error" в поле "error" state-топика
        * остановив wb-mqtt-serial и получив ошибку (предыдущий пункт), перезапускаем wb-mqtt-serial -> жмём "scan" -> ошибка должна пропасть
        * добавив в wb-mqtt-serial несуществующие порты и запустив сканирование, получаем ошибку "com.wb.device_manager.failed_to_scan_error" в поле "error" state-топика и список несуществующих портов в "error.metadata.failed_ports"
        * убрав из конфига wb-mqtt-serial все несуществующие порты, снова запустить сканирование. Ошибок быть не должно; обратить внимание на правильность коллизий slaveid
        * в json-e state'a - адекватная информация (особенно - вокруг настроек связи)
        * поле "progress" в state-топике доходит до 100% по завершению сканирования. Открыть webui, проследить, что прогрессбар не дёргается назад за N=5 сканирований
        * когда сканирование завершено, "scanning":false; "progress":0
        * повесить несколько устройств с одинаковым slaveid и serial-настройками на один порт. Запустить сканирование в webui. Вся информация (fw-signature, device-signature, fw-version, ...) должна вычитаться из устройств без ошибок
    * #### остановка сканирования (*/bus-scan/Stop):
        * если сканирование сейчас не выполняется - возвращает ошибку 33100 на вызовы
        * если сканирование выполняется - сразу завершает его (как быстрое, так и медленное). По завершению, "scanning":false; "progress":0
